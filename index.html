<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test</title>
	<script src="/socket.io/socket.io.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>
	<div class="js-game-lobby">
		<div class="num_user"></div>
		<button type="button" class="js-start-game">Играть</button>
	</div>
	<textarea class="js-textarea" placeholder="Текст вашего сообщения..." style="display: none;"></textarea>
	<button type="button" class="js-send-message" style="display: none;">Отправить</button>
	<div class="js-video-panel" style="display: none;"></div>
	<div class="js-messages-history" style="display: none;"></div>
</body>
<script src="//cdn.webrtc-experiment.com/RTCMultiConnection-v1.8.js"></script>
<!--<script src="http://www.rtcmulticonnection.org/latest.js"></script>-->
<script>
	// Connect to imitation game
	$('.js-start-game').one('click', function(){
		$(this).text('Ожидание других игроков...');

		var inGame = false,
			socket = io.connect('/'),
			connection = new RTCMultiConnection(),
			role,
			name,
			question,
			intro,
			remoteMediaElements = [];

		socket.on('game.role', function (data){
			role = data.role;
			name = data.name;
			intro = data.intro;
			question = data.question || '';
			connection.userid = name;
			connection.session = {
				data: true,
				audio: true,
				video: true
			};

			$('.js-textarea, .js-send-message, .js-messages-history, .js-video-panel').show();
			$('.js-game-lobby').hide();

			socket.on('room.addUser',function(data){
				$('.num_user').html(data.users+"/3");
			});

			// initiate webrtcmulticonnection between 3 browsers
			socket.on('webrtc.multiconnection.open', function (data) {
				connection.open(data.roomId);
				socket.emit('webrtc.multiconnection.ready');
			});
			socket.on('webrtc.multiconnection.connect', function (data){
				connection.connect(data.roomId);
			});

			setTimeout(function(){
				if (role === 'seeker' && confirm(question)) {
					socket.emit('game.vote', {vote: 1});
				} else {
					socket.emit('game.vote', {vote: 0});
				}
			}, 1000 * 60); // 1 minute

			socket.on('game.over', function (data) {
				if (role === 'seeker') {
					var player1 = remoteMediaElements.pop();
					player1.muted = false;
					player1.play();
					player1.volume = 0.9;
					$(player1).appendTo($('.js-video-panel'));

					var player2 = remoteMediaElements.pop();
					player2.muted = false;
					player2.play();
					player2.volume = 0.9;
					$(player2).appendTo($('.js-video-panel'));
				}

				$message = $('<div></div>');
				$message.text(data.message);
				$message.appendTo($('.js-messages-history'));
			});

			connection.onmessage = function(e) {
				$message = $('<div></div>');
				$message.text(e.userid + ': ' + e.data);
				$message.appendTo($('.js-messages-history'));
			};

			connection.onstream = function(event) {
				// don't show remote video streams for host
				if (event.type === 'local' || role !== 'seeker') {
					event.mediaElement.muted = true;
					$(event.mediaElement).appendTo($('.js-video-panel'));
				} else {
					event.mediaElement.muted = true;
					event.mediaElement.pause();
					event.mediaElement.userid = name;
					remoteMediaElements.push(event.mediaElement);
				}
			};

			$('.js-send-message').on('click', function() {
				connection.send($('.js-textarea').val());

				$message = $('<div></div>');
				$message.text('Я: ' + $('.js-textarea').val());
				$message.appendTo($('.js-messages-history'));

				$('.js-textarea').val('');
			});

			$message = $('<div></div>');
			$message.text(intro);
			$message.appendTo($('.js-messages-history'));
		});
	});
</script>
</html>
