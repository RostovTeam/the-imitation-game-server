<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test</title>
	<script src="/socket.io/socket.io.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>
	<div class="num_user"></div>
	<button id="connectBtn">Connect</button>
	<div id="chat">
		<textarea id="message" placeholder="Type a message..."></textarea>
		<button id="sendMessageBtn">Send</button>
		<div id="vote_panel" style="display: none;">
			<button id="player1_vote">Vote Player 1</button>
			<label>Male: <input type="radio" name="player1" value="male"></radio></label>
			<label>Female: <input type="radio" name="player1" value="female"></radio></label>

			<button id="player2_vote">Vote PLayer 2</button>
			<label>Male: <input type="radio" name="player2" value="male"></radio></label>
			<label>Female: <input type="radio" name="player2" value="female"></radio></label>
		</div>
	</div>
</body>
<script src="http://www.rtcmulticonnection.org/latest.js"></script>
<script>
	var domMessage = document.querySelector('#message'),
		domChat = document.querySelector('#chat'),
		domConnect = document.querySelector('#connectBtn'),
		domSend = document.querySelector('#sendMessageBtn'),
		isHost = false,
		removeStreams = [];

	domConnect.onclick = function() {
		var socket = io.connect('/'),
			connection = new RTCMultiConnection(); // @todo: what is 'channel id' here?

		connection.session = {
			data: true,
			audio: true,
			video: true
		};

		// connection established, waiting another players
		domConnect.innerHTML = 'Waiting...';

        socket.on('room.addUser',function(data){
			$('.num_user').html(data.users+"/3");
			console.log(data.users);
			domConnect.innertHtml = data.users;
		});
		socket.on('webrtc.multiconnection.open', function (data) {
			// it means this client must create a new connection
			// another clients will be connected later
			connection.open(data.room);
			socket.emit('webrtc.multiconnection.ready');
			socket.emit('game.role');
		});

		socket.on('webrtc.multiconnection.connect', function(data){
			connection.connect(data.room);
			socket.emit('game.role');
		});

		socket.on('game.role', function(data){
			if (data.role === 'seeker') {
				isHost = true;
				document.querySelector('#vote_panel').style.display = 'block';
				var vote1 = document.querySelector('#player1_vote'),
					vote2 = document.querySelector('#player2_vote'),
					gameFinish = 2,
					gameOver = function() {
						if (--gameFinish <= 0) {
							socket.emit('game.vote');
						}
					};
				vote1.onclick = function(event) {
					vote1.disabled = true;
					gameOver();
				};
				vote2.onclick = function(event) {
					vote2.disabled = true;
					gameOver();
				};
			}
		});

		socket.on('game.over', function() {
			if (isHost) {
				var player1 = removeStreams.pop();
				player1.play();
				document.body.appendChild(player1);

				var player2 = removeStreams.pop();
				player2.play();
				document.body.appendChild(player2);
			}
		});

		connection.onmessage = function(e) {
			var domP = document.createElement('p');
			domP.innerHTML = e.data;
			domChat.appendChild(domP);
		};

		connection.onstream = function(event) {
			// don't show remote video streams for host
			if (event.type === 'local' || ! isHost) {
				document.body.appendChild( event.mediaElement );
			} else {
				event.mediaElement.pause();
				removeStreams.push(event.mediaElement);
			}

			// activate chat area
			domChat.style.display = '';
			domConnect.style.display = 'none';
		};

		domSend.onclick = function() {
			connection.send(domMessage.value);

			var domP = document.createElement('p');
			domP.innerHTML = domMessage.value;
			domChat.appendChild(domP);

			domMessage.value = '';
		};

		// hide chat area until connection established
		
		domChat.style.display = 'none';
	};
</script>
</html>
